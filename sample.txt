<%@page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awaiting Push</title>
    <link rel="stylesheet" href="/assets/ss/css/custom.css">
    <link rel="stylesheet" href="/assets/ss/css/branding.css">
    <link rel="stylesheet" href="/assets/ss/css/notification.css">
    <link rel="stylesheet" href="/assets/ss/css/fidel.css">
    <link rel="stylesheet" href="/assets/ss/css/bootstrap-4.6/bootstrap.min.css">
    <style>
        .btn.disabled, .btn[disabled] {
            color: #212529;
            background-color: #e9ecef;
            opacity: 1 !important;
            border-color: #dee2e6;
        }
    </style>
</head>
<body>
    <div class="sso-branding container">
        <img src="/assets/sso/images/bofa-logo-new.svg" class="sso-logo" alt="Bank of America Logo" width="325" height="75">
        <div class="sso-login">
            <h1 class="pushHeaderLabel"><%= pushHeaderLabel %></h1>
            <div role="main">
                <div class="progress-container mb-4">
                    <div class="progress-ring">
                        <svg>
                            <circle class="progress-ring__circle" stroke="#0d6efd" stroke-width="4" fill="transparent" r="50" cx="100" cy="100"></circle>
                        </svg>
                    </div>
                    <div class="progress-info">
                        <p class="time-remaining">00:<span id="time-remaining-number">59</span></p>
                        <p id="timerLabel"><%= pushTimerLabel %></p>
                    </div>
                </div>
                <div class="d-flex align-items-center justify-content-center">
                    <p class="text-center light"><%= pushInstr %></p>
                </div>
                <form id="login" name="login" method="post" action="<%= formAction %>" autocomplete="off">
                    <div class="d-flex align-items-center justify-content-center button my-3">
                        <button class="btn btn-primary btn-block" id="usbAuthBtn" type="submit" tabindex="2"><%= buttonCode %></button>
                    </div>
                    <input type="hidden" name="action" id="action" value="<%= OTPConstants.FORM_ACTION_SECURITYCODE %>">
                </form>
                <div class="d-flex align-items-center justify-content-center button my-3">
                    <button class="btn btn-secondary btn-block" id="authBtn" tabindex="3" onclick="handleIAmUnableBtn()">I am unable to complete Authentication</button>
                </div>
            </div>
        </div>
    </div>
    <script src="/assets/sso/js/jquery.3.5.1.min.js"></script>
    <script src="/assets/ss/js/bootstrap-4.6/bootstrap.min.js"></script>
    <script>
        var currentRequest = null;

        setTimeout(function() {
            var time = 59; // how long the timer will run (seconds)
            var initialOffset = '628';
            var i = 1;
            var displayTime = 59;

            // Need initial run as interval hasn't yet occurred...
            $('#circle_animation').css('stroke-dashoffset', initialOffset - (1*(initialOffset/time)));
            var interval = setInterval(function() {
                var timeLeft = time - i;
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    document.getElementById('timerLabel').innerHTML = "Time Expired";
                    window.location.replace('/bofaotp/ui/pushExpire');
                } else {
                    timeLabel = timeLeft;
                }
                $('#time-remaining-number').text(timeLabel);
                if (i == time) {
                    clearInterval(interval);
                }
                $('#circle_animation').css('stroke-dashoffset', initialOffset - ((i+1)*(initialOffset/time)));
                i++;
            }, 1000);

            $("form").submit(function() {
                $(this).find(":submit").attr('disabled', 'disabled');
            });
        }, 0);

        function checkPushStatus() {
            if (currentRequest) {
                currentRequest.abort();
            }

            pollingInprogress = true;
            var url = "https://<%=hostURL%>"+"<%=formAction%>";

            currentRequest = $.ajax({
                url: url,
                method: "POST",
                data: {
                    action: "poll_notification"
                },
                error: function() {
                    pollingInprogress = false;
                },
                success: function(data, textStatus, jqXHR) {
                    pollingInprogress = false;
                    if (cancelEvent == "CANCEL") {
                        return handleIAmUnableBtn();
                    }

                    var x = document.createElement('div');
                    x.innerHTML = data;

                    if ($(x).querySelector("#checkstatusvalidated") != null) {
                        $('#action').val("<%= OTPConstants.FORM_ACTION_OTP_VALIDATE %>");
                        $("#login").submit();
                    }
                },
                complete: function(jqXHR, textStatus) {
                    $(".btn").prop("disabled", false);
                    pollingInprogress = false;
                    if (isInitial) {
                        clearInterval(interval);
                        interval = setInterval(checkPushStatus, subsequentPollingInterval);
                        isInitial = false;
                    }
                }
            });
        }

        function handleIAmUnableBtn() {
            if (currentRequest) {
                currentRequest.abort();
            }

            pollingInprogress = false;
            $(".authbtn").prop("disabled", false);
            var formObj = document.forms["login"];
            formObj["action"].value = 'otp_cancel';
            formObj.submit();
            cancelEvent = "CANCEL";
        }
    </script>
</body>
</html>
